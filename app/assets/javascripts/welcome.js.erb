/*
 *= require jquery
 *= require jquery.tubular.1.0
 *= require jquery_nested_form
 *= require angular
 *= require angular-route
 *= require angular-animate
 */

!function () {
  "use strict";

    // Number guest fieldsets. Skip hidden (to-be-deleted) ones.
    var countGuests = function () {
      var $form = $('.section--rsvp form'),
        $visibleFieldsets = $form.find('fieldset:visible')
      $visibleFieldsets.each(function (i, e) {
        $(e).find('legend').text("Guest #" + (i + 1))
      });
      $form.find('.remove_nested_fields').toggle($visibleFieldsets.length > 1)
      return $form;
    };

    var assetLocation = <%= 'document.location.protocol + "//assets." + document.location.host + ' if Rails.env == 'production' %>"/objects/"

    // Replace RSVP form with AJAX response.
    $(document).on('submit', '.section--rsvp form', function () {
      var $this = $(this),
        guestFail = false
      // Only look for visible guest names - deleted names still exist in the
      // DOM
      $this.find('.guest_name:visible').each(function () {
        var val = $(this).val()
        if (val === "Guest") {
          // don't submit form if person says cancel - set guestFail to true
          // which will return false down below
          guestFail = !confirm('It looks like you have left some guests\' names as "Guest". Do you want to continue to RSVP and provide their names some time later?')
          return false
        } else if (val === "") {
          alert('Please fill in all guest names, or remove guests who are not coming!');
          guestFail = true
          return false
        }
        return true
      });
      if (guestFail) {
        return false
      }
      $.ajax($this.attr('action'), {
        type: $this.attr('method'),
        data: $this.serialize(),
        dataType: 'html',
        success: function (data) {
          var $container = $this.closest('.section');
          $container.empty().html(data);
          countGuests.call($container);
          $('.flash', $container).fadeOut(5000)
        }
      });
      return false
    });

    // Count guests if a form loads with the page, and when guests are added
    // or removed.
    $(document).on('nested:fieldAdded nested:fieldRemoved', '.section--rsvp form', countGuests);

    $('body').tubular({videoId: 'iOA46XuRRI8', start: 31, ratio: 4/3});

    var angularApp = angular.module('AdalAndLily', ['ngRoute', 'ngAnimate']);
    angularApp
      .config(['$locationProvider', '$routeProvider', function ($locationProvider, $routeProvider) {

        $routeProvider
          .when('/', {
            controller: 'MainController',
            template: ''
          })
          .when('/:page', {
            controller: 'PageController',
            templateUrl: 'page.html'
          })
          .otherwise({
            redirectTo: '/'
          });
      }])
      .controller('MainController', ['$scope', '$routeParams', function ($scope, $routeParams) {
      }])
      .controller('PageController', ['$scope', '$routeParams', function ($scope, $routeParams) {
          $scope.page = $routeParams.page;
          countGuests();
      }])
}();